const downloadBtn = document.getElementById('downloadPDF');
if (downloadBtn) {
  downloadBtn.addEventListener('click', async () => {
    try {
      // Prevent double-click
      downloadBtn.disabled = true;
      downloadBtn.innerText = "Preparing PDF...";

      // Ensure print-friendly view
      document.body.classList.add('for-pdf');

      // give browser a tiny moment to reflow DOM (show print-name etc.)
      await new Promise(r => setTimeout(r, 150));

      const elem = document.getElementById('invoiceCard');
      const bgColor = getComputedStyle(document.body).backgroundColor || '#ffffff';

      // html2canvas capture
      const canvas = await html2canvas(elem, {
        scale: 2,
        backgroundColor: bgColor,
        useCORS: true,
        allowTaint: true,
        imageTimeout: 0
      });

      const imgData = canvas.toDataURL('image/png');
      const { jsPDF } = window.jspdf;
      const pdf = new jsPDF('p', 'pt', 'a4');

      const pdfWidth = pdf.internal.pageSize.getWidth();
      const pdfHeight = (canvas.height * pdfWidth) / canvas.width;

      pdf.addImage(imgData, 'PNG', 0, 0, pdfWidth, pdfHeight);

      const fileName = 'ar_invoice_' + new Date().toISOString().slice(0, 19).replace(/[:T]/g, '-') + '.pdf';
      pdf.save(fileName);
    } catch (err) {
      console.error("PDF generation failed:", err);
      alert("⚠️ PDF generation failed. Open console to debug.");
    } finally {
      // restore page and button
      document.body.classList.remove('for-pdf');
      downloadBtn.disabled = false;
      downloadBtn.innerText = "Download PDF";
    }
  });
